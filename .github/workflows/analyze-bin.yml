name: Convert BAT to EXE, Patch & Analyze

on:
  push:
    paths:
      - 'dataspammer.bat'

permissions:
  contents: read
  security-events: write

jobs:
  convert-and-analyze:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Bat To Exe Converter
      run: |
        Invoke-WebRequest https://github.com/l-urk/Bat-To-Exe-Converter-64-Bit/releases/download/3.2/Bat_To_Exe_Converter_x64.exe -OutFile BatToExe.exe

    - name: Convert dataspammer.bat to dataspammer.exe
      run: |
        .\BatToExe.exe /bat dataspammer.bat /exe dataspammer.exe /x64 /invisible /uac-admin
    
    - name: Setup MSVC developer environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Apply ASLR flags with editbin
      run: |
        editbin.exe /DYNAMICBASE /HIGHENTROPYVA dataspammer.exe

    - name: Download BinSkim from NuGet
      run: |
        Invoke-WebRequest `
          https://www.nuget.org/api/v2/package/Microsoft.CodeAnalysis.BinSkim -OutFile binskim.nupkg

    - name: Extract BinSkim
      run: |
        Rename-Item binskim.nupkg binskim.zip
        Expand-Archive binskim.zip -DestinationPath binskim

    - name: Run BinSkim analysis
      run: |
        .\binskim\tools\net9.0\win-x64\BinSkim.exe analyze dataspammer.exe --recurse --output results.sarif

    - name: Upload SARIF report
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif
