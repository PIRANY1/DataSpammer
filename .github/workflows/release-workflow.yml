name: Build and Release Setup

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: 📥 Repository auschecken
        uses: actions/checkout@v4

      - name: 🧵 UTF-16 BOM + Bytes an dataspammer.bat anhängen
        run: |
            $bytes = 0xFF,0xFE,0x0D,0x0A,0x63,0x6C,0x73,0x0D,0x0A
            $original = Get-Content ".\dataspammer.bat" -Encoding Byte
            $combined = [byte[]]::Concat($bytes, $original)
            Set-Content ".\dataspammer.bat" -Encoding Byte -Value $combined

      - name: 📝 LEAVEHERE in installer.ifp mit absolutem Pfad von dataspammer.bat ersetzen
        run: |
            $batPath = (Resolve-Path ".\dataspammer.bat").Path
            $ifp = Get-Content ".github/installer.ifp" -Raw
            $ifp = $ifp -replace 'LEAVEHERE', $batPath
            Set-Content ".github/installer.ifp" -Value $ifp
            Get-Content ".github/installer.ifp"
      - name: 🔧 InstallForge installieren
        run: |
          Invoke-WebRequest -Uri "https://installforge.net/download/InstallForge_Setup.exe" -OutFile installforge.exe
          Start-Process .\installforge.exe /SILENT -Wait

      - name: 🔨 Installer erstellen mit InstallForge CLI
        run: |
          $env:Path += ";C:\Program Files (x86)\InstallForge"
          installforge /B ".github\installer.ifp"
